<!DOCTYPE html>
<!-- Disable quirks mode -->
<html mol_view_root>
<!-- Reset root styles -->

<head>
	<meta charset="utf-8" />
	<!-- Force utf-8 encoding -->
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1" />
	<!-- Disable mobile browser auto zoom, $mol is adaptive -->
	<meta name="mobile-web-app-capable" content="yes" />
	<!-- Fullscreen support -->
	<meta name="apple-mobile-web-app-capable" content="yes" />
</head>

<body mol_view_root onload="init();">
	<!-- Reset root styles -->
	<div mol_view_root="$milis_ballsort"></div>
	<!-- Autobind component to element on load -->
	<script src="web.js"></script>
	<!-- Load autogenerated js bundle -->
	<h1>Очень грязно на $mol xD</h1>
	<canvas id="game" width="800" height="600"></canvas>

</body>
<script type="text/javascript" src="https://d309knd7es5f10.cloudfront.net/Box2dWeb-2.1.a.3.min.js"></script>
<script type="text/javascript">
	var gb = function() {
   var b2Vec2 = Box2D.Common.Math.b2Vec2;
   var b2BodyDef = Box2D.Dynamics.b2BodyDef;
   var b2Body = Box2D.Dynamics.b2Body;
   var b2FixtureDef = Box2D.Dynamics.b2FixtureDef;
   var b2Fixture = Box2D.Dynamics.b2Fixture;
   var b2World = Box2D.Dynamics.b2World;
   var b2MassData = Box2D.Collision.Shapes.b2MassData;
   var b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;
   var b2CircleShape = Box2D.Collision.Shapes.b2CircleShape;
   var b2DebugDraw = Box2D.Dynamics.b2DebugDraw
   var w = 800;
   var h = 600;
   var gamePhysics;
   var gameCanvas = document.getElementById("game");
   var ctx = gameCanvas.getContext('2d');
   var activeBlock;

   var blockTypes = {};
	  blockTypes.b1 = new Image();
	  blockTypes.b1.src = 'https://webislife.ru/bubl2/b1.png';

	  blockTypes.b2 = new Image();
	  blockTypes.b2.src = 'https://webislife.ru/bubl2/b2.png';
	  blockTypes.b3 = new Image();
	  blockTypes.b3.src = 'https://webislife.ru/bubl2/b3.png';
	  blockTypes.ground = new Image();
	  blockTypes.b3.src = 'https://webislife.ru/bubl2/b3.png';
	  blockTypes.bgLevel = new Image();
	  blockTypes.bgLevel.src = 'https://webislife.ru/bubl2/bg.jpg';
	  
   var blocks = function(physics, i) {
	  var body = this.body = new b2BodyDef();
		 body.position = new b2Vec2(i.x, i.y);
		 body.linearVelocity = new b2Vec2 (i.vx || 0, i.vy || 0);
		 body.userData = {
		type: i.u.type,
		status: i.u.status || false
		 };
		 body.active = true;
		 body.allowSleep = true;
		 body.angle = 0;
		 body.angularVelocity = 0;
		 body.awake = true;
		 body.bullet = false;
		 body.fixedRotation = false;
		 body.type = i.type || b2Body.b2_dynamicBody;
		 body.x = i.x || 0;
		 body.y = i.y || 0;
		 body = physics.world.CreateBody(body);
		 
	  var fixture = new b2FixtureDef();
		 fixture.density = 1;
		 fixture.friction =  1;
		 fixture.restitution = 1;
		 fixture.shape = new b2CircleShape(15/gamePhysics.scale);
		 body.CreateFixture(fixture);
	  
   }
   var ground = function(physics, i) {
	  var body = this.body = new b2BodyDef();
		 body.position = new b2Vec2(i.x, i.y);
		 body.linearVelocity = new b2Vec2 (i.vx || 0, i.vy || 0);
		 body.userData = {
		type: "ground",
		status: false
		 };
		 body.width = i.width || 1;
		 body.height = i.height || 1;
		 body.active = true;
		 body.allowSleep = true;
		 body.angle = 0;
		 body.angularVelocity = 0;
		 body.awake = true;
		 body.bullet = false;
		 body.fixedRotation = false;
		 body.type = b2Body.b2_staticBody;
		 body.x = i.x || 0;
		 body.y = i.y || 0;
		 body = physics.world.CreateBody(body);
		 
	  var fixture = new b2FixtureDef();
		 fixture.density = 1;
		 fixture.friction =  1;
		 fixture.restitution = 1;
		 fixture.shape = new b2PolygonShape();
		 fixture.shape.SetAsBox(i.width,i.height);
		 body.CreateFixture(fixture);
	  
   }
   var levels = {
	  1: [
		 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		 [1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1],
		 [1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1],
		 [1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1],
		 [1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1],
		 [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1]
	  ]
   }
   var Physics = this.Physics = function(element,scale) {
		 var gravity = new b2Vec2(0,0);
		 this.world = new b2World(gravity, true);
		 this.element = element;
		 this.context = element.getContext("2d");
		 this.scale = scale || 30;
		 this.stepAmount = 1000/60;
   };
   var mouseListener = function(){
	  gameCanvas.addEventListener('click', function(e){
		 var x = -((415/gamePhysics.scale)-e.offsetX / gamePhysics.scale);
		 var y = -((515/gamePhysics.scale)-e.offsetY / gamePhysics.scale);
		 var body = gamePhysics.world.GetBodyList();
		 if (body.GetUserData().type == 'activeBlock') {
		
		 }
		 //Придаем импульс
		 body.ApplyImpulse({ x: x, y: y }, body.GetWorldCenter());
		 //Генерируем новый шар
		 
		 function addNewBlock() {
		activeBlock = new blocks(gamePhysics, {x:w/2/gamePhysics.scale, type: b2Body.b2_dynamicBody, y:500/gamePhysics.scale, vy:0, vx:0, u:{type:getrandTypeBlock(), status: true}});
		 }
		 setTimeout(addNewBlock, 180);
	  });
   }
   Physics.prototype.debug = function() {
		 this.debugDraw = new b2DebugDraw();
		 this.debugDraw.SetSprite(this.context);
		 this.debugDraw.SetDrawScale(this.scale);
		 this.debugDraw.SetFillAlpha(0.2);
		 this.debugDraw.SetLineThickness(1.0);
		 this.debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
		 this.world.SetDebugDraw(this.debugDraw);
   };
   Physics.prototype.step = function (dt) {
		 this.world.Step(1/60, 1, 1);
		 if (this.debugDraw) {
		 this.world.DrawDebugData();
		 }
   }
   //Physics.prototype.collision
   //Главный цикл
   var gameloop = function(physics)
   {
	  
	  
	  //Рендер игры
	  gamePhysics.step(1000/60);
	  //gamePhysics.debug();
	  ctx.clearRect(0, 0, w, h);
	  ctx.drawImage(blockTypes['bgLevel'], 0, 0,800, 600);
	  
	  //Перебираем body в мире и рисуем
	  if(gamePhysics.world.GetBodyList()){
		 var robj = gamePhysics.world.GetBodyList();
		 if (robj) {
		while(robj) {
		   
		   var body = robj.GetUserData();
		   if (body) {
		  if (body.destroy) {
			 gamePhysics.world.DestroyBody(robj);
		  }
		  //if (body.status == false) {
		  //   robj.SetLinearVelocity({ x: 0, y: 0 }, robj.GetWorldCenter());
		  //}
		  ctx.drawImage(blockTypes[body.type], robj.GetPosition().x*gamePhysics.scale, robj.GetPosition().y*gamePhysics.scale);
		   }
		   robj = robj.GetNext();
		}
		 }
	  }
	  
	  ctx.restore();
	  console.log('tik');
   }
   this.start = function(){
	  
	  console.log('start game');
	  
	  gamePhysics = new Physics(gameCanvas);
	  
	  //Заполняем мир уровня физическими блоками
	  var level = levels[1];
	  for (var r = 0; r<level.length; r++) {
		 for(var c = 0; c<level[r].length; c++){
		
		if (level[r][c] == 1) {
		   console.log('make blok');
		   new blocks(gamePhysics, {x:((c)*30+25)/gamePhysics.scale, y:((r)*30+25)/gamePhysics.scale, vy:0, vx:0, u:{type:getrandTypeBlock(), status: false}});
		}
		
		 }
	  }
	  new ground(gamePhysics, {x:0, y:1, height: h/gamePhysics.scale, width: 10/gamePhysics.scale});
	  new ground(gamePhysics, {x:w/gamePhysics.scale, y:1, height: h/gamePhysics.scale, width: 10/gamePhysics.scale});
	  activeBlock = new blocks(gamePhysics, {x:w/2/gamePhysics.scale, type: b2Body.b2_dynamicBody, y:500/gamePhysics.scale, vy:0, vx:0, u:{type:getrandTypeBlock(), status: true}});

	  
	  //Слушатель событий
		  var listener = new Box2D.Dynamics.b2ContactListener();
		  listener.BeginContact = function(contact) {
			  console.log('start contact');
	  var body1 = contact.GetFixtureA().GetBody();
	  var body2 = contact.GetFixtureB().GetBody();
	  //body1.ApplyForce({ x: 0, y: 0 }, body1.GetWorldCenter());
	  //body2.ApplyForce({ x: 0, y: 0 }, body2.GetWorldCenter());
	  //body1.SetLinearVelocity({ x: 0, y: 0 }, body1.GetWorldCenter());
	  //body2.SetLinearVelocity({ x: 0, y: 0 }, body2.GetWorldCenter());
				 
			}
		  listener.EndContact = function(contact) {
		  console.log('end contact');
	  var body1 = contact.GetFixtureA().GetBody();
	  var body2 = contact.GetFixtureB().GetBody();
	  
	  var newPositionX = Math.round(((body1.GetPosition().x*gamePhysics.scale+25))/gamePhysics.scale);
	  var newPositionY = Math.round(((body1.GetPosition().y*gamePhysics.scale+25))/gamePhysics.scale);
	  
	  body1.SetLinearVelocity(newPositionX*60, newPositionY*60);
	  
	  
	  
	  body1.SetLinearVelocity({ x: 0, y: 0 }, body1.GetWorldCenter());
	  
	  //Если столкнулись два блока
	  if (body1.GetUserData().type == body2.GetUserData().type) {
		console.log('Одинаковые');
		
		
		
		var topBlockVec = new b2Vec2(body2.GetPosition().x, body2.GetPosition().y-0.5);
		var rightBlockVec = new b2Vec2(body2.GetPosition().x+1, body2.GetPosition().y);
		//Проверка сверху
		function checkTopBlock(data)
		{
		   var topblock = data.GetBody();
		   if (topblock.GetUserData().type == body1.GetUserData().type) {
		  console.log('Еще выше совпал');
		  var newUserData = body2.GetUserData();
		  newUserData.destroy = true;
		  topblock.SetUserData(newUserData);
		  topBlockVec.y = topBlockVec.y-0.5;
		  gamePhysics.world.QueryPoint(checkTopBlock, new b2Vec2(body2.GetPosition().x, topBlockVec.y))
		  return true;
		   } else {
		  console.log('Еще выше не совпал');
		   }
		   
		}
		//Проверка Справа
		function checkRightBlock(data)
		{
		   var topblock = data.GetBody();
		   if (topblock.GetUserData().type == body1.GetUserData().type) {
		  console.log('Еще правее совпал');
		  var newUserData = body2.GetUserData();
		  newUserData.destroy = true;
		  topblock.SetUserData(newUserData);
		  rightBlockVec.x = rightBlockVec.x+0.5;
		  gamePhysics.world.QueryPoint(checkTopBlock, new b2Vec2(rightBlockVec.x, body2.GetPosition().y))
		  return true;
		   } else {
		  console.log('Еще правее не совпал');
		   }
		   
		}
		
		
		gamePhysics.world.QueryPoint(checkRightBlock, rightBlockVec);
		gamePhysics.world.QueryPoint(checkTopBlock, topBlockVec);
		
		//Добавляем для удаления
		var newUserData = body2.GetUserData();
		newUserData.destroy = true;
		body2.SetUserData(newUserData);
		body1.SetUserData(newUserData);
		
	  }
	  
			}
	  //Добавляем слушатель в мир
	  gamePhysics.world.SetContactListener(listener);
	  
	  new mouseListener();
	  setInterval(function(){gameloop();}, 1000/60);

   }
   function getRandInt(min, max){return Math.ceil(Math.random() * (max - min) + min);}
   function getrandTypeBlock() {
	  var int = getRandInt(0,3);
	  int = 'b'+int;
	  return int;
   }
	}
	function init(){
   var game = new gb();
   game.start();
	}
 </script>

</html>
